import streamlit as st
from deep_translator import GoogleTranslator
import speech_recognition as sr
import edge_tts
import asyncio
import pygame
import os
from datetime import datetime
import threading

# --------------------------
# üéß Functie om tekst uit te spreken
# --------------------------

async def spreek_tekst(tekst, taalcode):
    stemmap = {
        "nl": "nl-NL-MaartenNeural",
        "fr": "fr-FR-DeniseNeural",
        "pt": "pt-BR-AntonioNeural",
        "zh-CN": "zh-CN-XiaoxiaoNeural",
        "es": "es-ES-AlvaroNeural",
        "de": "de-DE-ConradNeural",
        "en-US": "en-US-AriaNeural",
        "ln": "pt-BR-AntonioNeural",
    }

    stem = stemmap.get(taalcode, "en-US-AriaNeural")
    mp3_bestand = "tts_edge.mp3"
    communicate = edge_tts.Communicate(tekst, stem)
    await communicate.save(mp3_bestand)

    pygame.mixer.init()
    pygame.mixer.music.load(mp3_bestand)
    pygame.mixer.music.play()
    while pygame.mixer.music.get_busy():
        pygame.time.Clock().tick(10)
    pygame.mixer.quit()
    os.remove(mp3_bestand)

# --------------------------
# üîç Hulpfunctie: vind juiste CABLE Input
# --------------------------

def vind_cable_input_index():
    apparaten = sr.Microphone.list_microphone_names()
    cable_indices = [i for i, naam in enumerate(apparaten) if "CABLE Input" in naam]
    return cable_indices[0] if cable_indices else None

# --------------------------
# üß† Hoofdprogramma
# --------------------------

def start_luisteren(bron_taal, doel_taal, medium):
    recognizer = sr.Recognizer()
    recognizer.dynamic_energy_threshold = True
    stop_gewenst = False

    def wacht_op_enter():
        nonlocal stop_gewenst
        input("üîö Druk op Enter om te stoppen...\n")
        stop_gewenst = True

    threading.Thread(target=wacht_op_enter, daemon=True).start()

    try:
        if medium == "Zoom":
            indexmic = vind_cable_input_index()
            mic = sr.Microphone(device_index=indexmic if indexmic is not None else None)
        else:
            mic = sr.Microphone()
    except Exception as e:
        st.error(f"‚ùå Fout bij kiezen van microfoon: {e}")
        return

    st.info("üéôÔ∏è Begin met spreken. Druk op Enter in de terminal om te stoppen.")

    try:
        with mic as source:
            recognizer.adjust_for_ambient_noise(source)
            with open("vertaling_resultaat.txt", "w", encoding="utf-8") as bestand:
                while not stop_gewenst:
                    st.write("‚è≥ Luisteren naar zin...")
                    try:
                        audio = recognizer.listen(source, phrase_time_limit=10)
                        zin = recognizer.recognize_google(audio, language=bron_taal).strip()

                        st.write(f"üó£Ô∏è Origineel ({bron_taal}): {zin}")
                        try:
                            vertaling = GoogleTranslator(source=bron_taal, target=doel_taal).translate(zin)
                        except Exception as e:
                            st.warning(f"‚ö†Ô∏è Vertaling mislukt: {e}")
                            vertaling = zin

                        st.write(f"üåê Vertaling ({doel_taal}): {vertaling}")
                        asyncio.run(spreek_tekst(vertaling, doel_taal))

                        tijd = datetime.now().strftime("%H:%M:%S")
                        bestand.write(f"[{tijd}] Origineel ({bron_taal}): {zin}\n")
                        bestand.write(f"[{tijd}] Vertaling ({doel_taal}): {vertaling}\n\n")

                    except sr.UnknownValueError:
                        st.warning("‚ö†Ô∏è Kon zin niet herkennen. Probeer opnieuw.")
                    except sr.RequestError as e:
                        st.error(f"‚ö†Ô∏è Fout bij spraakherkenning: {e}")
                        break

        st.success("üõë Vertaling be√´indigd. Bestand opgeslagen als 'vertaling_resultaat.txt'.")

    except Exception as e:
        st.error(f"‚ùå Fout bij openen van microfoon: {e}")

# --------------------------
# üöÄ Streamlit Interface
# --------------------------

st.title("üåç Live Spraakvertaler voor de Prediking")

st.markdown("Gebruik een headset of richtmicrofoon voor de beste kwaliteit.")

bron_taal = st.selectbox("Welke taal spreekt de pastoor?", ["fr", "pt", "nl", "zh-CN", "ln"])
doel_taal = st.selectbox("Welke taal wil je horen?", ["nl", "fr", "pt", "zh-CN", "ln", "en-US"])
medium = st.radio("Hoe volg je de prediking?", ["Zaal", "Zoom"])

if st.button("üéß Start live vertaling"):
    start_luisteren(bron_taal, doel_taal, medium)
